System.register(["./db-legacy-1802c10b.js","./pocketbase-legacy-d584ed5d.js","./index-legacy-a6b9922c.js"],(function(e,t){"use strict";var r,a,s,i,n,o,y,c,d;return{setters:[e=>{r=e.d,a=e.S,s=e.a},e=>{i=e.t,n=e.p},e=>{o=e.Q,y=e.t,c=e.r,d=e.j}],execute:function(){e("action",(async()=>{try{return await o.promise(t,{pending:y`notify.syncing in progress`,success:y`notify.syncing completed`,error:{render:({data:e})=>y("notify.syncing error",{error:JSON.stringify(e)+"\n"+JSON.stringify(e?.data)})}}),c("/manage")}catch(e){return e instanceof i&&console.error(e.data),d({error:"Có lỗi xảy ra"})}}));const t=async()=>{const[e,t]=await Promise.all([r.list.where("syncStatus").anyOf([a.NotSync,a.NeedResync]).toArray(),r.data.where("syncStatus").anyOf([a.NotSync,a.NeedResync]).toArray()]);for(const r of e){const e=t.filter((({surveyId:e})=>e===r.surveyId)),a={};for(let t of e)a[t.surveyForm]=t.data;await u(r,a)}const i=await r.revision.where({syncStatus:a.NotSync}).toArray(),o=[];for(const r of i)await n.collection("survey_revisions").create({user:n.authStore.model?.id,survey_offline_id:r.surveyId,form_name:r.surveyForm,created:s(r.surveyDataId),data:r.data}),o.push(r.surveyDataId);await r.revision.bulkDelete(o)};async function u(e,t,s=!0){try{if(e.remoteSurveyId)await n.collection("surveys").update(e.remoteSurveyId,{survey_data:t}),await r.list.update(e.surveyId,{syncStatus:a.Synced});else{const s=await n.collection("surveys").create({user:n.authStore.model?.id,offline_id:e.surveyId,type:e.surveyType,created:e.createdAt,survey_data:t});await r.list.update(e.surveyId,{remoteSurveyId:s.id,syncStatus:a.Synced})}}catch(o){if(o instanceof i&&404===o.status){if(await r.list.update(e.surveyId,{remoteSurveyId:null}),s){const{remoteSurveyId:r,...a}=e;await u(a,t,!1)}return}if(o instanceof i&&400===o.status&&"validation_not_unique"===o.data?.data?.offline_id?.code){const a=await n.collection("surveys").getList(1,1,{filter:`offline_id = "${e.surveyId}"`});if(1===a.totalItems){const i=a.items?.[0]?.id;if(i)return await r.list.update(e.surveyId,{remoteSurveyId:i}),void(s&&await u({...e,remoteSurveyId:i},t,!1))}}throw o}}}}}));
