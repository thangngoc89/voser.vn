System.register(["./db-legacy-1802c10b.js","./pocketbase-legacy-d584ed5d.js","./index-legacy-6f8d08d0.js"],(function(e,t){"use strict";var a,r,s,i,n,o,u,c;return{setters:[e=>{a=e.d,r=e.S,s=e.a},e=>{i=e.p,n=e.t},e=>{o=e.Q,u=e.r,c=e.j}],execute:function(){async function t(e,s,o=!0){try{if(e.remoteSurveyId)await i.collection("surveys").update(e.remoteSurveyId,{survey_data:s}),await a.list.update(e.surveyId,{syncStatus:r.Synced});else{const t=await i.collection("surveys").create({user:i.authStore.model?.id,offline_id:e.surveyId,type:e.surveyType,created:e.createdAt,survey_data:s});await a.list.update(e.surveyId,{remoteSurveyId:t.id,syncStatus:r.Synced})}}catch(u){if(u instanceof n&&404===u.status){if(await a.list.update(e.surveyId,{remoteSurveyId:null}),o){const{remoteSurveyId:a,...r}=e;await t(r,s,!1)}return}if(u instanceof n&&400===u.status&&"validation_not_unique"===u.data?.data?.offline_id?.code){const r=await i.collection("surveys").getList(1,1,{filter:`offline_id = "${e.surveyId}"`});if(1===r.totalItems){const i=r.items?.[0]?.id;if(i)return await a.list.update(e.surveyId,{remoteSurveyId:i}),void(o&&await t({...e,remoteSurveyId:i},s,!1))}}throw u}}window.pb=i,e("action",(async()=>{try{const[e,n]=await Promise.all([a.list.where("syncStatus").anyOf([r.NotSync,r.NeedResync]).toArray(),a.data.where("syncStatus").anyOf([r.NotSync,r.NeedResync]).toArray()]);for(const a of e){const e=n.filter((({surveyId:e})=>e===a.surveyId)),r={};for(let t of e)r[t.surveyForm]=t.data;await t(a,r)}const c=await a.revision.where({syncStatus:r.NotSync}).toArray(),y=[];for(const t of c)await i.collection("survey_revisions").create({user:i.authStore.model?.id,survey_offline_id:t.surveyId,form_name:t.surveyForm,created:s(t.surveyDataId),data:t.data}),y.push(t.surveyDataId);return await a.revision.bulkDelete(y),o.success("Đồng bộ thành công"),u("/manage")}catch(e){return e instanceof n&&console.error(e.data),o.error("Có lỗi xảy ra trong quá trình đồng bộ, vui lòng thử lại\n"+e.toString()+"\n"+JSON.stringify(e.data)),c({error:"Có lỗi xảy ra"})}}))}}}));
