System.register(["./db-legacy-1a76ad35.js","./pocketbase-legacy-7a1413fe.js","./index-legacy-729ef95d.js"],(function(t,e){"use strict";var r,a,s,i,o,n,u,c;return{setters:[t=>{r=t.d,a=t.S,s=t.a},t=>{i=t.p,o=t.t},t=>{n=t.Q,u=t.r,c=t.j}],execute:function(){async function e(t,s,n=!0){try{if(t.remoteSurveyId)await i.collection("surveys").update(t.remoteSurveyId,{survey_data:s}),await r.list.update(t.surveyId,{syncStatus:a.Synced});else{const e=await i.collection("surveys").create({user:i.authStore.model?.id,offline_id:t.surveyId,type:t.surveyType,created:t.createdAt,survey_data:s});await r.list.update(t.surveyId,{remoteSurveyId:e.id,syncStatus:a.Synced})}}catch(u){if(u instanceof o&&404===u.status){if(await r.list.update(t.surveyId,{remoteSurveyId:null}),n){const{remoteSurveyId:r,...a}=t;await e(a,s,!1)}return}if(u instanceof o&&400===u.status&&"validation_not_unique"===u.data?.data?.offline_id?.code){const a=await i.collection("surveys").getList(1,1,{filter:`offline_id = "${t.surveyId}"`});if(1===a.totalItems){const i=a.items?.[0]?.id;if(i)return await r.list.update(t.surveyId,{remoteSurveyId:i}),void(n&&await e({...t,remoteSurveyId:i},s,!1))}}throw u}}t("action",(async()=>{try{const[t,o]=await Promise.all([r.list.where({syncStatus:a.NotSync}).toArray(),r.data.where({syncStatus:a.NotSync}).toArray()]);for(const r of t){const t=o.filter((({surveyId:t})=>t===r.surveyId)),a={};for(let e of t)a[e.surveyForm]=e.data;await e(r,a)}const c=await r.revision.where({syncStatus:a.NotSync}).toArray(),d=[];for(const e of c)await i.collection("survey_revisions").create({user:i.authStore.model?.id,survey_offline_id:e.surveyId,form_name:e.surveyForm,created:s(e.surveyDataId),data:e.data}),d.push(e.surveyDataId);return await r.revision.bulkDelete(d),n.success("Đồng bộ thành công"),u("/manage")}catch(t){return t instanceof o&&console.error(t.data),n.error("Có lỗi xảy ra trong quá trình đồng bộ, vui lòng thử lại\n"+t.toString()+"\n"+JSON.stringify(t.data)),c({error:"Có lỗi xảy ra"})}}))}}}));
